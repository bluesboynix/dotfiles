;;; lang-nim.el --- Nim support (Emacs 30+) -*- lexical-binding: t; -*-
;;; Commentary:
;; Modern Nim setup for Emacs 30+
;; - tree-sitter (nim-ts-mode)
;; - eglot (LSP client)
;; - flymake (built-in diagnostics)
;; - completion-at-point (capf)
;; - nimpretty format on save
;; - nimble project helpers

;;; Code:

(when (treesit-available-p)
  (add-to-list 'treesit-language-source-alist
               '(nim "https://github.com/alaviss/tree-sitter-nim"))

  (unless (treesit-language-available-p 'nim)
    (treesit-install-language-grammar 'nim))

  ;; Use tree-sitter Nim mode automatically
  (add-to-list 'major-mode-remap-alist
-mode . nim-ts-mode)))

;; --------------------------------------------------
;; Eglot (built-in LSP client)
;; --------------------------------------------------

(with-eval-after-load 'eglot
  (add-to-list 'eglot-server-programs
               '((nim-ts-mode) . ("nimlangserver"))))

(defun lang-nim-eglot-setup ()
  "Start Eglot for Nim."
  (when (executable-find "nimlangserver")
    (eglot-ensure)))

(add-hook 'nim-ts-mode-hook #'lang-nim-eglot-setup)

;; --------------------------------------------------
;; Basic editor settings
;; --------------------------------------------------

(defun lang-nim-common-setup ()
  "Common Nim configuration."
  (setq-local indent-tabs-mode nil
              tab-width 2)

  ;; Enable Flymake (built-in)
  (flymake-mode 1)

  ;; Enable Eldoc
  (eldoc-mode 1)

  ;; Imenu support
  (imenu-add-menubar-index))

(add-hook 'nim-ts-mode-hook #'lang-nim-common-setup)

;; --------------------------------------------------
;; Format on save (nimpretty)
;; --------------------------------------------------

(defun lang-nim-format-buffer ()
  "Format current Nim buffer using nimpretty."
  (interactive)
  (when (and buffer-file-name
             (executable-find "nimpretty"))
    (call-process "nimpretty" nil nil nil buffer-file-name)
    (revert-buffer t t t)
    (message "Formatted with nimpretty")))

(defun lang-nim-format-on-save ()
  "Auto-format Nim buffers before save."
  (when (derived-mode-p 'nim-ts-mode)
    (lang-nim-format-buffer)))

(add-hook 'before-save-hook #'lang-nim-format-on-save)

;; --------------------------------------------------
;; Nimble project helpers
;; --------------------------------------------------

(defun lang-nim--project-root ()
  "Find Nimble project root."
  (or (locate-dominating-file default-directory ".nimble")
      default-directory))

(defun lang-nim-build ()
  "Build Nim project."
  (interactive)
  (let ((default-directory (lang-nim--project-root)))
    (compile "nimble build")))

(defun lang-nim-run ()
  "Run Nim project."
  (interactive)
  (let ((default-directory (lang-nim--project-root)))
    (compile "nimble run")))

(defun lang-nim-test ()
  "Run Nim tests."
  (interactive)
  (let ((default-directory (lang-nim--project-root)))
    (compile "nimble test")))

;; --------------------------------------------------
;; REPL
;; --------------------------------------------------

(defun lang-nim-repl ()
  "Start Nim REPL (inim)."
  (interactive)
  (if (executable-find "inim")
      (make-comint "nim-repl" "inim")
    (message "Install REPL: nimble install inim")))

;; --------------------------------------------------
;; Keybindings
;; --------------------------------------------------

(with-eval-after-load 'nim-ts-mode
  (define-key nim-ts-mode-map (kbd "C-c C-b") #'lang-nim-build)
  (define-key nim-ts-mode-map (kbd "C-c C-r") #'lang-nim-run)
  (define-key nim-ts-mode-map (kbd "C-c C-t") #'lang-nim-test)
  (define-key nim-ts-mode-map (kbd "C-c C-z") #'lang-nim-repl)
  (define-key nim-ts-mode-map (kbd "C-c C-f") #'lang-nim-format-buffer))

;; --------------------------------------------------

(provide 'lang-nim)
;;; lang-nim.el ends here
